# opentofu-unraid-docker
OpenTofu Modules for Unraid docker

## Version 1.0 Release Notes
The module is now completed and ready for release as version 1.0. The Unraid UI configuration has been updated to exclude the "net.unraid.docker.managed" variable, which is not managed by Unraid. This change allows the configuration to be saved in XML format for backup purposes. The module has been tested in Unraid 7.1.4.

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| containers | Map of container configurations with unique keys for stable resource addressing | `map(object)` | n/a | yes |
| unraid | Unraid server configuration for XML template deployment | `object` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| container_ids | Map of container IDs created by the Docker container module |
| container_names | Map of container names created by the Docker container module |
| xml_file_paths | Map of XML file paths generated by the Unraid XML module |
| xml_file_contents | Map of XML file contents generated by the Unraid XML module |

## Example

```hcl
containers = {
  keycloak = {
    name       = "keycloak"
    hostname   = "keycloak"
    image      = "quay.io/keycloak/keycloak:25.0"
    network    = "keycstack"
    restart    = "on-failure"
    pids_limit = 2048
    command    = ["start"]

    envs = [
      { name = "KC_HOSTNAME", value = "sso.example.com" },
      { name = "KC_DB", value = "postgres" }
    ]

    capabilities = {
      add  = ["NET_ADMIN"]
      drop = ["MKNOD"]
    }

    security_opts = [
      "label=type:container_t",
      "label=level:s0:c1,c2"
    ]

    ports = [
      { host = 33443, container = 8443, protocol = "tcp" }
    ]

    mounts = [
      { type = "bind", host_path = "/mnt/user/appdata/keycloak/", container_path = "/mnt/certs/", mode = "rw" },
      { type = "tmpfs", container_path = "/var/tmpfs_data", tmpfs_options = { mode = 0777, size_bytes = 1048576 } }
    ]

    configs = [
      { file = "/etc/k0s/k0s.yaml", source = "./configs/k0s.yaml" }
    ]

    template_data = {
      enable       = true
      shell        = "bash"
      repository   = "https://github.com/keycloak/keycloak"
      support      = "https://github.com/keycloak/keycloak/discussions"
      project      = "https://www.keycloak.org/"
      overview     = "Keycloak identity and access management"
      category     = "Security:"
      webui        = "https://sso.example.com"
      template_url = ""
      icon         = "https://example.com/keycloak.png"
      extra_params = ""
      date_installed = "2024-01-01"
      donate_text  = ""
      donate_link  = ""
    }
  }
}

unraid = {
  host           = "192.168.1.100"
  user           = "root"
  ssh_privatekey = "/path/to/private/key"
}
```

## XML Template Generation

The module supports conditional XML template generation for Unraid. Set `template_data.enable = false` to disable XML generation for specific containers while still creating the Docker container.

## Docker Connection via SSH
To connect to the Docker daemon on the Unraid machine via SSH, you need to add your SSH key and export the `DOCKER_HOST` environment variable. You can do this by running the following commands:
```
export DOCKER_HOST="ssh://<user>@<host>"
```
Replace `<user>` and `<host>` with the actual username and hostname of your Unraid machine.
